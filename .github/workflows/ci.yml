name: CI

on:
  workflow_call:
    inputs:
      filters:
        description: Filters passed to pnpm turbo run commands
        type: string
        required: true
      name:
        description: Name of the calling workflow for concurrency grouping
        type: string
        required: true
      node-version:
        description: Node.js version to use
        type: number
        required: true
    outputs:
      api-hash:
        description: Hash of the API source directory
        value: ${{ jobs.CI.outputs.api-hash }}
      manager-hash:
        description: Hash of the Manager source directory
        value: ${{ jobs.CI.outputs.manager-hash }}

env:
  TURBO_TELEMETRY_DISABLED: 1

jobs:
  CI:
    runs-on: ubuntu-latest
    name: Lint, Format, Typecheck, Test
    outputs:
      api-hash: ${{ steps.hash.outputs.api }}
      manager-hash: ${{ steps.hash.outputs.manager }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: '0'

      - name: Install
        uses: ./.github/actions/install
        with:
          node-version: ${{ inputs.node-version }}

      - name: Lint
        run: pnpm lint $TURBO_FILTERS

      - name: Format
        run: pnpm format $TURBO_FILTERS

      - name: Typecheck
        run: pnpm typecheck $TURBO_FILTERS

      - name: Test
        run: pnpm test $TURBO_FILTERS

      - name: Hash
        id: hash
        shell: bash
        run: |
          filters=${{ inputs.filters }}

          if [[ "$filters" == *"api"* ]]; then
            echo "api=${{ hashFiles('apps/api/**/*') }}" >> "$GITHUB_OUTPUT"
          fi

          if [[ "$filters" == *"manager"* ]]; then
            echo "manager=${{ hashFiles('apps/manager/**/*') }}" >> "$GITHUB_OUTPUT"
          fi

      - name: Context
        shell: bash
        run: |
          echo "âœ¨ Lint... âœ…"
          echo "ğŸ’… Format... âœ…"
          echo "ğŸ›¡ï¸ Typecheck... âœ…"
          echo "ğŸ§ª Test... âœ…"
          echo "#ï¸âƒ£ API source hash: ${{ steps.hash.outputs.api }}"
          echo "#ï¸âƒ£ Manager source hash: ${{ steps.hash.outputs.manager }}"
