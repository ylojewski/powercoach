name: Detect

on:
  workflow_call:
    outputs:
      branch-slug:
        description: Slugified branch name of the pull request
        value: ${{ jobs.detect.outputs.branch-slug }}
      ci:
        description: Whether CI should be ran
        value: ${{ jobs.detect.outputs.ci-filters != '' && 'true' || 'false' }}
      ci-filters:
        description: CI turbo filters
        value: ${{ jobs.detect.outputs.ci-filters }}
      ci-name:
        description: CI workflow name
        value: ${{ jobs.detect.outputs.ci-name }}
      event-pr:
        description: Whether it is a pull request event
        value: ${{ jobs.detect.outputs.event-pr }}
      event-push:
        description: Whether it is a push event
        value: ${{ jobs.detect.outputs.event-push }}
      path-api:
        description: Whether API has been modified
        value: ${{ jobs.detect.outputs.path-api }}
      path-manager:
        description: Whether Manager has been modified
        value: ${{ jobs.detect.outputs.path-manager }}

jobs:
  detect:
    name: Detect
    runs-on: ubuntu-latest
    outputs:
      branch-slug: ${{ steps.slug.outputs.value }}
      ci: ${{ steps.vars.outputs.filters != '' }}
      ci-filters: ${{ steps.vars.outputs.filters }}
      ci-name: ${{ steps.vars.outputs.name }}
      event-pr: ${{ steps.event.outputs.pr }}
      event-push: ${{ steps.event.outputs.push }}
      path-api: ${{ steps.paths.outputs.api }}
      path-manager: ${{ steps.paths.outputs.manager }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Modified paths
        uses: dorny/paths-filter@v3
        id: paths
        with:
          filters: |
            api:
              - 'apps/api/**'
            manager:
              - 'apps/manager/**'

      - name: CI variables
        shell: bash
        id: vars
        run: |
          api="${{ steps.paths.outputs.api }}"
          manager="${{ steps.paths.outputs.manager }}"

          if [[ "$api" == "true" && "$manager" == "true" ]]; then
            echo "filters=--filter=@powercoach/api --filter=@powercoach/manager" >> $GITHUB_OUTPUT
            echo "name=CI" >> $GITHUB_OUTPUT
          elif [[ "$api" == "true" ]]; then
            echo "filters=--filter=@powercoach/api" >> $GITHUB_OUTPUT
            echo "name=api CI" >> $GITHUB_OUTPUT
          elif [[ "$manager" == "true" ]]; then
            echo "filters=--filter=@powercoach/manager" >> $GITHUB_OUTPUT
            echo "name=Manager CI" >> $GITHUB_OUTPUT
          fi

      - name: Github event
        id: event
        shell: bash
        run: |
          echo "push=$([[ "${{ github.event_name }}" == 'push' ]] && echo true || echo false)" >> "$GITHUB_OUTPUT"
          echo "pr=$([[ "${{ github.event_name }}" == 'pull_request_target' ]] && echo true || echo false)" >> "$GITHUB_OUTPUT"

      - name: Branch slug
        if: ${{ steps.event.outputs.pr == 'true' }}
        id: slug
        shell: bash
        run: |
          slug="$(echo "${{ github.head_ref }}" | tr '[:upper:]' '[:lower:]')"
          slug="$(echo "$slug" | sed -E 's/[^a-z0-9]+/-/g')"
          slug="$(echo "$slug" | sed -E 's/^-*//')"
          slug="$(echo "$slug" | sed -E 's/-*$//')"
          echo "value=$slug" >> "$GITHUB_OUTPUT"

      - name: Detection
        shell: bash
        run: |
          echo "ğŸŒ Branch slug: ${{ steps.slug.outputs.value }}"
          echo "ğŸš€ CI: ${{ steps.vars.outputs.filters != '' && 'âœ…' || 'âŒ' }}"
          echo "ğŸ”€ CI turbo filters: ${{ steps.vars.outputs.filters }}"
          echo "ğŸ· CI workflow name: ${{ steps.vars.outputs.name }}"
          echo "ğŸ”€ Pull request event: ${{ steps.event.outputs.pr == 'true' && 'âœ…' || 'âŒ' }}
          echo "ğŸ”€ Push event: ${{ steps.event.outputs.push == 'true' && 'âœ…' || 'âŒ' }}
          echo "ğŸ“‚ Path API: ${{ steps.paths.outputs.api == 'true' && 'âœ…' || 'âŒ' }}
          echo "ğŸ“‚ Path Manager: ${{ steps.paths.outputs.manager == 'true' && 'âœ…' || 'âŒ' }}
