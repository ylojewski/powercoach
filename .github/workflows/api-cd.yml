name: API CD

on:
  workflow_run:
    workflows: ['API CI']
    branches:
      - main
    types:
      - completed

concurrency:
  group: ${{ github.workflow }}-${{ github.event.workflow_run.head_branch }}
  cancel-in-progress: true

permissions:
  actions: read
  contents: read
  id-token: write

env:
  IMAGE: ${{ secrets.GCP_REGION }}-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/${{ secrets.GAR_REPOSITORY }}/${{ secrets.GCP_SERVICE }}:${{ github.event.workflow_run.head_sha }}

jobs:
  deploy:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8
        with:
          ref: ${{ github.event.workflow_run.head_sha }}

      - name: Google Auth
        uses: google-github-actions/auth@7c6bc770dae815cd3e89ee6cdf493a5fab2cc093
        with:
          workload_identity_provider: ${{ secrets.WIF_PROVIDER }}
          service_account: ${{ secrets.WIF_SERVICE_ACCOUNT }}
          token_format: 'access_token'

      - name: Setup gcloud
        uses: google-github-actions/setup-gcloud@aa5489c8933f4cc7a4f7d45035b3b1440c9c10db

      - name: Configure Docker auth for Artifact Registry
        run: |
          gcloud auth configure-docker ${{ secrets.GCP_REGION }}-docker.pkg.dev --quiet

      - name: Build image
        run: |
          docker build \
            -f apps/api/Dockerfile \
            -t "${IMAGE}" \
            .

      - name: Push image
        run: docker push "${IMAGE}"

      - name: Deploy to Cloud Run
        run: |
          gcloud run deploy "${{ secrets.GCP_SERVICE }}" \
            --image="${IMAGE}" \
            --region="${{ secrets.GCP_REGION }}" \
            --platform=managed \
            --allow-unauthenticated \
            --project="${{ secrets.GCP_PROJECT_ID }}" \
            --set-env-vars="HOST=0.0.0.0,NODE_ENV=production,LOG_LEVEL=info" \
            --port=8080 \
            --memory=512Mi \
            --cpu=1 \
            --max-instances=10 \
            --startup-probe httpGet.path=/v1/health,initialDelaySeconds=5,periodSeconds=2,timeoutSeconds=1,failureThreshold=5 \
            --liveness-probe httpGet.path=/v1/health
