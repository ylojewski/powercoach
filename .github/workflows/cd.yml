name: CD

on:
  push:
    branches:
      - main

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  actions: read
  contents: read
  id-token: write

env:
  IMAGE: ${{ secrets.GCP_REGION }}-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/${{ secrets.GAR_REPOSITORY }}/${{ secrets.GCP_SERVICE }}:${{ github.sha }}

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8

      - name: Google Auth
        uses: google-github-actions/auth@7c6bc770dae815cd3e89ee6cdf493a5fab2cc093
        with:
          workload_identity_provider: ${{ secrets.WIF_PROVIDER }}
          service_account: ${{ secrets.WIF_SERVICE_ACCOUNT }}
          token_format: "access_token"

      - name: Setup gcloud
        uses: google-github-actions/setup-gcloud@aa5489c8933f4cc7a4f7d45035b3b1440c9c10db

      - name: Configure Docker auth for Artifact Registry
        run: |
          gcloud auth configure-docker ${{ secrets.GCP_REGION }}-docker.pkg.dev --quiet

      - name: Build image
        run: |
          docker build \
            -f apps/api/Dockerfile \
            -t "${IMAGE}" \
            .

      - name: Push image
        run: docker push "${IMAGE}"

      - name: Deploy to Cloud Run
        run: |
          gcloud run deploy "${{ secrets.GCP_SERVICE }}" \
            --image="${IMAGE}" \
            --region="${{ secrets.GCP_REGION }}" \
            --platform=managed \
            --allow-unauthenticated \
            --project="${{ secrets.GCP_PROJECT_ID }}" \
            --set-env-vars="HOST=0.0.0.0,NODE_ENV=production,LOG_LEVEL=info,PORT=8080" \
            --port=8080 \
            --memory=512Mi \
            --cpu=1 \
            --max-instances=10

      - name: Service URL
        run: |
          gcloud run services describe "${{ secrets.GCP_SERVICE }}" \
            --region="${{ secrets.GCP_REGION }}" \
            --project="${{ secrets.GCP_PROJECT_ID }}" \
            --format='value(status.url)'
