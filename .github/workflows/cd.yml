name: CD

on:
  workflow_call:
    inputs:
      api-changed:
        description: Whether API has been modified
        type: boolean
        required: true
      api-hash:
        description: Hash of the API dist directory
        type: string
        required: true
      branch-slug:
        description: Slugified branch name of the pull request
        type: string
        required: true
      gcp-artifacts-repository:
        description: Google Cloud Platform artifacts repository
        type: string
        required: true
      gcp-domain:
        description: Google Cloud Platform URL
        type: string
        required: true
      gcp-project-id:
        description: Google Cloud Platform project id
        type: string
        required: true
      gcp-region:
        description: Google Cloud Platform region
        type: string
        required: true
      gcp-service:
        description: Google Cloud Platform service
        type: string
        required: true
      is-push:
        description: Whether it is a push event
        type: boolean
        required: true
      is-pr:
        description: Whether it is a pull request event
        type: boolean
        required: true
      manager-changed:
        description: Whether Manager has been modified
        type: boolean
        required: true
      manager-hash:
        description: Hash of the Manager dist directory
        type: string
        required: true
      node-version:
        description: Node.js version to use
        type: number
        required: true
      vcl-project:
        description: Vercel project
        type: string
        required: true
      vcl-team:
        description: Vercel team
        type: string
        required: true
    outputs:
      api-url:
        description: Deployed API URL
        value: ${{ jobs.CD.outputs.api-url }}
      manager-host:
        description: Deployed Manager host
        value: ${{ jobs.CD.outputs.manager-host }}
      manager-rollback-host:
        description: Manager host to rollback to
        value: ${{ jobs.CD.outputs.manager-rollback-host }}
    secrets:
      GCP_SERVICE_ACCOUNT:
        required: true
      GCP_WIF_PROVIDER:
        required: true
      VCL_TOKEN:
        required: true
  workflow_dispatch:

env:
  TURBO_TELEMETRY_DISABLED: 1
  VERCEL_TELEMETRY_DISABLED: 1

jobs:
  CD:
    name: Deploy Api, Manager
    runs-on: ubuntu-latest
    if: ${{ github.event_name != 'workflow_dispatch' }}
    outputs:
      # api-url: ${{ steps.api.outputs.url }}
      api-url: 'https://ci-test-new---api-gkrxksmsua-ew.a.run.app/'
      manager-url: ${{ steps.manager-preview.outputs.url || steps.manager-production.outputs.url }}
      manager-rollback-host: ${{ steps.manager-production.outputs.rollback-host }}
    steps:
      - name: Inputs
        shell: bash
        run: |
          {
            echo "### CD inputs"
            echo ""
            echo "| Key | Value |"
            echo "| --- | --- |"
            echo "| API changed | ${{ inputs.api-changed && '✅' || '❌' }} |"
            echo "| API hash | ${{ inputs.api-hash || '❌' }} |"
            echo "| Branch slug | ${{ inputs.branch-slug || '❌' }} |"
            echo "| Is push | ${{ inputs.is-push && '✅' || '❌' }} |"
            echo "| Is pull request | ${{ inputs.is-pr && '✅' || '❌' }} |"
            echo "| GCP artifacts repository | ${{ inputs.gcp-artifacts-repository || '❌' }} |"
            echo "| GCP domain | ${{ inputs.gcp-domain || '❌' }} |"
            echo "| GCP project id | ${{ inputs.gcp-project-id || '❌' }} |"
            echo "| GCP region | ${{ inputs.gcp-region || '❌' }} |"
            echo "| GCP service | ${{ inputs.gcp-service || '❌' }} |"
            echo "| Manager changed | ${{ inputs.manager-changed && '✅' || '❌' }} |"
            echo "| Manager hash | ${{ inputs.manager-hash || '❌' }} |"
            echo "| Node version | ${{ inputs.node-version || '❌' }} |"
            echo "| Vercel project | ${{ inputs.vcl-project || '❌' }} |"
            echo "| Vercel team | ${{ inputs.vcl-team || '❌' }} |"
            echo ""
          } >> "$GITHUB_STEP_SUMMARY"

      - name: Checkout
        uses: actions/checkout@v4

      - name: Install
        uses: ./.github/actions/install
        with:
          node-version: ${{ inputs.node-version }}

      # - name: Deploy API
      #   uses: ./.github/actions/cd-api
      #   id: api
      #   with:
      #     artifacts-repository: ${{ inputs.gcp-artifacts-repository }}
      #     project-id: ${{ inputs.gcp-project-id }}
      #     region: ${{ inputs.gcp-region }}
      #     service: ${{ inputs.gcp-service }}
      #     service-account: ${{ secrets.GCP_SERVICE_ACCOUNT }}
      #     tag: ${{ inputs.branch-slug }}
      #     wif-provider: ${{ secrets.GCP_WIF_PROVIDER }}

      - name: Deploy preview Manager
        uses: ./.github/actions/cd-manager-preview
        if: ${{ inputs.is-pr }}
        id: manager-preview
        with:
          alias: ${{ inputs.branch-slug }}
          # api-url: ${{ steps.api.outputs.url }}
          api-url: 'https://ci-test-new---api-gkrxksmsua-ew.a.run.app/'
          hash: ${{ inputs.manager-hash }}
          project: ${{ inputs.vcl-project }}
          team: ${{ inputs.vcl-team }}
          token: ${{ secrets.VCL_TOKEN }}

      - name: Deploy production Manager
        uses: ./.github/actions/cd-manager-production
        if: ${{ inputs.is-push }}
        id: manager-production
        with:
          hash: ${{ inputs.manager-hash }}
          project: ${{ inputs.vcl-project }}
          team: ${{ inputs.vcl-team }}
          token: ${{ secrets.VCL_TOKEN }}

      - name: Outputs
        shell: bash
        run: |
          {
            echo "### CD outputs"
            echo ""
            echo "| Key | Value |"
            echo "| --- | --- |"
            echo "| API URL | https://ci-test-new---api-gkrxksmsua-ew.a.run.app/ |"
            echo "| Manager URL | ${{ steps.manager-preview.outputs.url || steps.manager-production.outputs.url || '❌' }} |"
            echo "| Manager rollback host | ${{ steps.manager-production.outputs.rollback-host || '❌' }} |"
            echo ""
          } >> "$GITHUB_STEP_SUMMARY"

  rollback-manager:
    name: Rollback Manager
    runs-on: ubuntu-latest
    if: ${{ inputs.is-push && github.event_name == 'workflow_dispatch' }}
    needs: CD
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install
        uses: ./.github/actions/install
        with:
          node-version: ${{ inputs.node-version }}

      - name: Rollback Manager
        run: |
          vercel rollback ${{ needs.CD.outputs.manager-rollback-host }} --token ${{ secrets.VCL_TOKEN }}
          echo "\u21A9\uFE0F Manager rollbacked on: ${{ needs.CD.outputs.manager-rollback-host }}"
