name: CD

on:
  workflow_call:
    inputs:
      api-changed:
        description: Whether API has been modified
        type: boolean
        required: true
      api-hash:
        description: Hash of the API dist directory
        type: string
        required: true
      branch-slug:
        description: Slugified branch name of the pull request
        type: string
        required: true
      is-push:
        description: Whether it is a push event
        type: boolean
        required: true
      is-pr:
        description: Whether it is a pull request event
        type: boolean
        required: true
      manager-changed:
        description: Whether Manager has been modified
        type: boolean
        required: true
      manager-hash:
        description: Hash of the Manager dist directory
        type: string
        required: true
      node-version:
        description: Node.js version to use
        type: number
        required: true
    outputs:
      api-url:
        description: Deployed API URL
        value: ${{ jobs.CD.outputs.api-url }}
      manager-host:
        description: Deployed Manager host
        value: ${{ jobs.CD.outputs.manager-host }}
      manager-rollback-host:
        description: Manager host to rollback to
        value: ${{ jobs.CD.outputs.manager-rollback-host }}
    secrets:
      GCP_ARTIFACTS_REPOSITORY:
        required: true
      GCP_PROJECT_ID:
        required: true
      GCP_REGION:
        required: true
      GCP_SERVICE:
        required: true
      GCP_SERVICE_ACCOUNT:
        required: true
      GCP_SERVICE_URL:
        required: true
      GCP_WIF_PROVIDER:
        required: true
      VCL_PROJECT:
        required: true
      VCL_TEAM:
        required: true
      VCL_TOKEN:
        required: true
  workflow_dispatch:

jobs:
  CD:
    name: Deploy Api, Manager
    runs-on: ubuntu-latest
    if: ${{ github.event_name != 'workflow_dispatch' }}
    outputs:
      # api-url: ${{ steps.api.outputs.url }}
      api-url: 'https://ci-test-new---api-gkrxksmsua-ew.a.run.app/'
      manager-host: ${{ steps.manager-preview.outputs.host || steps.manager-production.outputs.host }}
      manager-rollback-host: ${{ steps.manager-production.outputs.rollback-host }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install
        uses: ./.github/actions/install
        with:
          node-version: ${{ inputs.node-version }}

      - name: Context
        shell: bash
        run: |
          echo "üîÄ Event type: ${{ inputs.is-pr && 'PR' || 'Push' }}"
          echo "üêå Branch slug: ${{ inputs.branch-slug }}"
          echo "#Ô∏è‚É£ API hash: ${{ inputs.api-hash }}"
          echo "#Ô∏è‚É£ Manager hash: ${{ inputs.manager-hash }}"
          echo "‚úèÔ∏è API changed: ${{ inputs.api-changed && '‚úÖ' || '‚ùå' }}"
          echo "‚úèÔ∏è Manager changed: ${{ inputs.manager-changed && '‚úÖ' || '‚ùå' }}"
          echo "üè∑Ô∏è Node version: ${{ inputs.node-version }}"

      # - name: Deploy API
      #   uses: ./.github/actions/cd-api
      #   id: api
      #   with:
      #     artifacts-repository: ${{ secrets.GCP_ARTIFACTS_REPOSITORY }}
      #     project-id: ${{ secrets.GCP_PROJECT_ID }}
      #     region: ${{ secrets.GCP_REGION }}
      #     service: ${{ secrets.GCP_SERVICE }}
      #     service-account: ${{ secrets.GCP_SERVICE_ACCOUNT }}
      #     tag: ${{ inputs.branch-slug }}
      #     wif-provider: ${{ secrets.GCP_WIF_PROVIDER }}

      - name: Deploy preview Manager
        uses: ./.github/actions/cd-manager-preview
        if: ${{ inputs.is-pr }}
        id: manager-preview
        with:
          alias: ${{ inputs.branch-slug }}
          # api-url: ${{ steps.api.outputs.url }}
          api-url: 'https://ci-test-new---api-gkrxksmsua-ew.a.run.app/'
          hash: ${{ inputs.manager-hash }}
          project: ${{ secrets.VCL_PROJECT }}
          team: ${{ secrets.VCL_TEAM }}
          token: ${{ secrets.VCL_TOKEN }}

      - name: Deploy production Manager
        uses: ./.github/actions/cd-manager-production
        if: ${{ inputs.is-push }}
        id: manager-production
        with:
          hash: ${{ inputs.manager-hash }}
          project: ${{ secrets.VCL_PROJECT }}
          team: ${{ secrets.VCL_TEAM }}
          token: ${{ secrets.VCL_TOKEN }}

  rollback-manager:
    name: Rollback Manager
    runs-on: ubuntu-latest
    if: ${{ inputs.is-push && github.event_name == 'workflow_dispatch' }}
    needs: CD
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install
        uses: ./.github/actions/install
        with:
          node-version: ${{ inputs.node-version }}

      - name: Rollback Manager
        run: |
          vercel rollback ${{ needs.CD.outputs.manager-rollback-host }} --token ${{ secrets.VCL_TOKEN }}
          echo "\u21A9\uFE0F Manager rollbacked on: ${{ needs.CD.outputs.manager-rollback-host }}"
