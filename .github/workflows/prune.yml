name: Prune

on:
  pull_request:
    branches:
      - main
    paths:
      - 'apps/api/**'
      - 'apps/manager/**'
    types:
      - closed

permissions:
  actions: read
  contents: read
  id-token: write

env:
  TURBO_TELEMETRY_DISABLED: 1
  VERCEL_TELEMETRY_DISABLED: 1

jobs:
  prune:
    name: Prune
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: ./.github/actions/core/install
      - uses: ./.github/actions/core/context
        id: context

      - name: Protect main branch
        shell: bash
        run: |
          if -e "$(printf '%s' 'main' | sha256sum | cut -c1-10)" "${{ steps.context.outputs.branch-sha }}"; then
            echo "‚ùå Error: pruning main branch is forbidden"
            exit 1
          fi

      - name: Prune API
        uses: ./.github/actions/core/prune/api
        env:
          GCP_ARTIFACTS_REPOSITORY: ${{ vars.GCP_ARTIFACTS_REPOSITORY }}
          GCP_PROJECT_ID: ${{ vars.GCP_PROJECT_ID }}
          GCP_REGION: ${{ vars.GCP_REGION }}
          GCP_SERVICE: ${{ vars.GCP_SERVICE }}
          GCP_SERVICE_ACCOUNT: ${{ secrets.GCP_SERVICE_ACCOUNT }}
          GCP_WIF_PROVIDER: ${{ secrets.GCP_WIF_PROVIDER }}
        with:
          branch-sha: ${{ steps.context.outputs.branch-sha }}
          pull-slug: ${{ steps.context.outputs.pull-slug }}

      - name: Prune Manager
        uses: ./.github/actions/core/prune/manager
        env:
          VCL_TOKEN: ${{ secrets.VCL_TOKEN }}
        with:
          branch-sha: ${{ steps.context.outputs.branch-sha }}
