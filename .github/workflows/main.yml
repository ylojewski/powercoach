name: Main

on:
  push:
    branches:
      - main
  pull_request_target:
    branches:
      - main
    paths:
      - 'apps/api/**'
      - 'apps/manager/**'

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  actions: read
  contents: read
  id-token: write

env:
  TURBO_TELEMETRY_DISABLED: 1
  VERCEL_TELEMETRY_DISABLED: 1

jobs:
  detect:
    uses: ./.github/workflows/detect.yml

  CI:
    needs: [detect]
    uses: ./.github/workflows/ci.yml
    if: ${{ needs.detect.outputs.ci == 'true' }}
    with:
      filters: ${{ needs.detect.outputs.ci-filters }}
      name: ${{ needs.detect.outputs.ci-name }}
      node-version: 20

  CD:
    needs: [detect, CI]
    uses: ./.github/workflows/cd.yml
    with:
      api-changed: ${{ needs.detect.outputs.path-api == 'true' }}
      api-hash: ${{ needs.CI.outputs.api-hash }}
      branch-slug: ${{ needs.detect.outputs.branch-slug }}
      is-pr: ${{ needs.detect.outputs.event-pr == 'true' }}
      is-push: ${{ needs.detect.outputs.event-push == 'true' }}
      manager-changed: ${{ needs.detect.outputs.path-manager == 'true' }}
      manager-hash: ${{ needs.CI.outputs.manager-hash }}
      node-version: 20
    secrets:
      GCP_ARTIFACTS_REPOSITORY: ${{ secrets.GCP_ARTIFACTS_REPOSITORY }}
      GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
      GCP_REGION: ${{ secrets.GCP_REGION }}
      GCP_SERVICE: ${{ secrets.GCP_SERVICE }}
      GCP_SERVICE_ACCOUNT: ${{ secrets.GCP_SERVICE_ACCOUNT }}
      GCP_SERVICE_URL: ${{ secrets.GCP_SERVICE_URL }}
      GCP_WIF_PROVIDER: ${{ secrets.GCP_WIF_PROVIDER }}
      VCL_PROJECT: ${{ secrets.VCL_PROJECT }}
      VCL_TEAM: ${{ secrets.VCL_TEAM }}
      VCL_TOKEN: ${{ secrets.VCL_TOKEN }}

  completed:
    runs-on: ubuntu-latest
    needs: [detect, CI, CD]
    steps:
      - name: Context
        shell: bash
        run: |
          echo "ðŸ”— API URL: ${{ needs.CD.outputs.api-url }}"
          echo "ðŸ”— Manager URL: https://${{ needs.CD.outputs.manager-host }}"
