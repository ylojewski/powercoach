name: Manager preview CD

inputs:
  alias:
    description: Vercel deployment alias
    required: true
  api-url:
    description: API URL used during build phase
    required: true
  hash:
    description: Hash of the dist directory
    required: true
  project:
    description: Vercel project name
    required: true
  team:
    description: Vercel team
    required: true
  token:
    description: Vercel token
    required: true

outputs:
  host:
    description: Deployed Manager host
    value: ${{ steps.alias-host.outputs.value }}

runs:
  using: composite
  steps:
    - name: Alias host computation
      id: alias-host
      shell: bash
      run: echo "value=${{ inputs.alias }}-${{ inputs.project }}-${{ inputs.team }}.vercel.app" >> "$GITHUB_OUTPUT"

    - name: Current deploy host
      id: current-deploy
      shell: bash
      run: |
        host=$(
          vercel list ${{ inputs.project }} \
            --token ${{ inputs.token }} \
            --environment preview \
            --status READY \
            --meta managerHash=${{ inputs.hash }} \
          | head -n1 \
          | sed 's|^https://||'
        )
        echo "host=$host" >> "$GITHUB_OUTPUT"
        echo "found=$([ -n "$host" ] && echo true || echo false)" >> "$GITHUB_OUTPUT"

    - name: Deploy
      id: new-deploy
      if: ${{ steps.current-deploy.outputs.found == 'false' }}
      shell: bash
      env:
        VITE_API_BASE_URL: ${{ inputs.api-url }}
      run: |
        pnpm --filter=@powercoach/manager build
        sed -i "s/__DIST_HASH__/${{ inputs.hash }}/g" apps/manager/dist/index.html

        vercel link \
          --token ${{ inputs.token }} \
          --project ${{ inputs.project }} \
          --cwd apps/manager/dist \
          --yes

        echo "host=$(
          vercel deploy \
            --token ${{ inputs.token }} \
            --meta managerHash=${{ inputs.hash }} \
            --cwd apps/manager/dist \
            --yes
        )"  >> "$GITHUB_OUTPUT"

    - name: Alias
      shell: bash
      run: |
        vercel alias set \
          "${{ steps.current-deploy.outputs.host || steps.new-deploy.outputs.host }}" \
          "${{ steps.alias-host.outputs.value }}" \
          --token ${{ inputs.token }}

    - name: Context
      shell: bash
      run: |
        echo "#ï¸âƒ£ Manager source hash: ${{ inputs.hash }}"
        echo "ğŸ” Found host: ${{ steps.current-deploy.outputs.host }}${{ steps.current-deploy.outputs.found == 'true' && ' âœ…' || 'âŒ' }}"
        echo "ğŸ› ï¸ Build: ${{ steps.current-deploy.outputs.found == 'false' && 'âœ…' || 'skipped â­ï¸' }}"
        echo "ğŸ·ï¸ï¸ Tag index.html: ${{ steps.current-deploy.outputs.found == 'false' && 'âœ…' || 'skipped â­ï¸' }}"
        echo "ğŸš€ Deploy host: ${{ steps.current-deploy.outputs.host || steps.new-deploy.outputs.host }}"
        echo "ğŸ”€ Alias host: ${{ steps.alias-host.outputs.value }}"
