name: Deploy to Vercel
description: Deployment logic for Vercel (build files, create deployment, wait until READY)

inputs:
  branch-sha:
    description: Github branch SHA
    required: true
  deploy-target:
    description: Deploy target, "preview" (pull event) or "production" (push event)
    required: true
  manager-sha:
    description: SHA of the Manager source directory
    required: true
  out-dir:
    description: Output directory to deploy
    required: true

outputs:
  id:
    description: Vercel deployment ID
    value: ${{ steps.deploy.outputs.id }}

runs:
  using: composite
  steps:
    - uses: ./.github/actions/core/validate/deploy-target
      with:
        deploy-target: ${{ inputs.deploy-target }}

    - uses: ./.github/actions/core/metadata
      id: metadata
      with:
        branch-sha: ${{ inputs.branch-sha }}
        manager-sha: ${{ inputs.manager-sha }}

    - name: Deploy to Vercel (core)
      id: deploy
      shell: bash
      run: |
        echo "ðŸ“¦ Creating deployment with"
        echo "  -- Branch SHA â‡’ ${{ inputs.branch-sha }}"
        echo "  -- Manager SHA â‡’ ${{ inputs.manager-sha }}"

        files=$(
          find "${{ inputs.out-dir }}" -type f -print0 \
          | while IFS= read -r -d '' file; do
              jq -n \
                --arg file "${file#"${{ inputs.out-dir }}"/}" \
                --rawfile data "$file" \
                '{ file: $file, data: $data }'
            done \
          | jq -s '.'
        )

        payload=$(
          printf '%s' "$files" \
          | jq \
            --arg branch_sha "${{ inputs.branch-sha }}" \
            --arg branch_metadata "${{ steps.metadata.outputs.branch-long-camel }}" \
            --arg manager_sha "${{ inputs.manager-sha }}" \
            --arg manager_metadata "${{ steps.metadata.outputs.manager-long-camel }}" \
            --arg production "${{ inputs.deploy-target == 'production' }}" \
            --arg project "$VCL_PROJECT" \
            '. as $files
              | {
                 files: $files,
                 meta: {
                   ($branch_metadata): $branch_sha,
                   ($manager_metadata): $manager_sha
                 },
                 name: $project,
                 project: $project
               }
              | if $production == "true" then . + { target: "production" } else . end
            '
        )

        id=$(
          printf '%s' "$payload" \
          | curl \
            --silent \
            --fail \
            --request POST \
            --header "Authorization: Bearer $VCL_TOKEN" \
            --header 'Content-Type: application/json' \
            --url "https://api.vercel.com/v13/deployments" \
            --data @- \
          | jq -r '.id'
        )

        if [[ -z "$id" || "$id" == "null" ]]; then
          echo "âŒ Failed to create deployment (missing ID)"
          exit 1
        fi

        echo "â³ Waiting for deployment to become READY..."

        wait_for_deployment_ready() {
          local id="$1"
          local max_attempts="${2:-20}"
          local delay="${3:-3}"
          local attempt=1

          while [[ "$attempt" -le "$max_attempts" ]]; do
            state=$(
              curl \
                --silent \
                --fail \
                --header "Authorization: Bearer $VCL_TOKEN" \
                --url "https://api.vercel.com/v13/deployments/$id" \
              | jq -r '.state // .readyState'
            )

            if [[ -z "$state" || "$state" == "null" ]]; then
              echo "âŒ No deployment state"
              exit 2
            fi

            case "$state" in
              READY) echo "âœ… Deployment ready"; return 0 ;;
              ERROR|CANCELED|CANCELLED|FAILED) echo "âŒ Deployment error (state=$state)"; exit 3 ;;
            esac

            attempt=$((attempt + 1))
            sleep "$delay"
          done

          echo "â° Deployment timeout"
          exit 4
        }

        wait_for_deployment_ready "$id"

        echo "id=$id" >> "$GITHUB_OUTPUT"
