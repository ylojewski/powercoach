name: Deploy to Vercel
description: Deployment logic for Vercel (build files, create deployment, wait until READY)

inputs:
  issue-number:
    description: Issue number of the pull request event
    required: false
  manager-hash:
    description: Hash of the Manager source directory
    required: true
  out-dir:
    description: Output directory to deploy
    required: true
  production:
    description: Whether to push with the --prod flag
    required: false

outputs:
  id:
    description: Vercel deployment ID
    value: ${{ steps.deploy.outputs.id }}

runs:
  using: composite
  steps:
    - name: Deploy to Vercel (core)
      id: deploy
      shell: bash
      run: |
        echo "ðŸ“¦ Creating deployment with"
        echo "  -- Manager hash â‡’ ${{ inputs.manager-hash }}"
        [[ -n "${{ inputs.issue-number }}" ]] && echo "  -- Issue number â‡’ ${{ inputs.issue-number }}"

        files=$(
          find "${{ inputs.out-dir }}" -type f -print0 \
          | while IFS= read -r -d '' file; do
              jq -n \
                --arg file "${file#"${{ inputs.out-dir }}"/}" \
                --rawfile data "$file" \
                '{ file: $file, data: $data }'
            done \
          | jq -s '.'
        )

        payload=$(
          printf '%s' "$files" \
          | jq \
            --arg issue "${{ inputs.issue-number }}" \
            --arg hash "${{ inputs.manager-hash }}" \
            --arg production "${{ inputs.production }}" \
            --arg project "$VCL_PROJECT" \
            '. as $files
              | {
                 files: $files,
                 meta: (if $issue != ""
                        then { powercoachManagerHash: $hash, powercoachIssueNumber: $issue }
                        else { powercoachManagerHash: $hash }
                        end),
                 name: $project,
                 project: $project
               }
              | if $production == "true" then . + { target: "production" } else . end
            '
        )

        id=$(
          printf '%s' "$payload" \
          | curl \
            --silent \
            --fail \
            --request POST \
            --header "Authorization: Bearer $VCL_TOKEN" \
            --header 'Content-Type: application/json' \
            --url "https://api.vercel.com/v13/deployments" \
            --data @- \
          | jq -r '.id'
        )

        if [[ -z "$id" || "$id" == "null" ]]; then
          echo "âŒ Failed to create deployment (missing ID)"
          exit 1
        fi

        echo "â³ Waiting for deployment to become READY..."

        wait_for_deployment_ready() {
          local id="$1"
          local max_attempts="${2:-20}"
          local delay="${3:-3}"
          local attempt=1

          while [[ "$attempt" -le "$max_attempts" ]]; do
            state=$(
              curl \
                --silent \
                --fail \
                --header "Authorization: Bearer $VCL_TOKEN" \
                --url "https://api.vercel.com/v13/deployments/$id" \
              | jq -r '.state // .readyState'
            )

            if [[ -z "$state" || "$state" == "null" ]]; then
              echo "âŒ No deployment state"
              exit 2
            fi

            case "$state" in
              READY) echo "âœ… Deployment ready"; return 0 ;;
              ERROR|CANCELED|CANCELLED|FAILED) echo "âŒ Deployment error (state=$state)"; exit 3 ;;
            esac

            attempt=$((attempt + 1))
            sleep "$delay"
          done

          echo "â° Deployment timeout"
          exit 4
        }

        wait_for_deployment_ready "$id"

        echo "id=$id" >> "$GITHUB_OUTPUT"
