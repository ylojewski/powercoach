name: Find Vercel hosts
description: Retrieves deployment URLs from Vercel via the v6 API

inputs:
  branch-slug:
    description: Slugified branch name of the pull request
    required: false
  hash:
    description: Commit hash to use as meta-hash (must produce exactly 1 host)
    required: false
  target:
    description: Vercel target environment (preview|production)
    required: false
    default: preview
  token:
    description: Vercel access token
    required: true

outputs:
  found:
    description: true if at least one host was found
    value: ${{ steps.find.outputs.found }}
  hosts:
    description: All hosts found (one per line, without https://)
    value: ${{ steps.find.outputs.hosts }}
  ids:
    description: All deployment IDs found (one per line, aligned with hosts)
    value: ${{ steps.find.outputs.ids }}

runs:
  using: composite
  steps:
    - name: Find Vercel hosts
      id: find
      shell: bash
      run: |
        token="${{ inputs.token }}"
        target="${{ inputs.target }}"
        hash="${{ inputs.hash }}"
        branch_slug="${{ inputs.branch-slug }}"

        if [[ -z "$branch_slug" && -z "$hash" ]]; then
          echo "âŒ Error: either 'branch-slug' or 'hash' must be provided." >&2
          exit 1
        fi

        [[ "$target" =~ ^(preview|production)$ ]] || {
          echo "âŒ Error: invalid 'target'=$target (allowed: preview|production)" >&2
          exit 1
        }

        query="target=$target"
        [[ -n "$branch_slug" ]] && query+="&meta-branchSlug=$branch_slug"
        [[ -n "$hash" ]] && query+="&meta-hash=$hash"

        url="https://api.vercel.com/v6/deployments?$query"

        echo "ðŸ” Querying Vercel with:"
        echo "  --target â‡’ $target"
        echo "  --branch slug â‡’ ${branch_slug:-"(not specified)"}"
        echo "  --hash â‡’ ${hash:-"(not specified)"}"

        response=$(
          curl \
            --silent \
            --fail \
            --header "Authorization: Bearer $token" \
            --url "$url"
        )

        urls="$(printf '%s\n' "$response" | jq -r '.deployments[].url // empty')"
        ids="$(printf '%s\n' "$response" | jq -r '.deployments[].uid // empty')"

        if [[ -z "$urls" ]]; then
          echo "â„¹ï¸ No hosts found"
          echo "found=false" >> "$GITHUB_OUTPUT"
          echo "hosts=" >> "$GITHUB_OUTPUT"
          echo "ids=" >> "$GITHUB_OUTPUT"
          exit 0
        fi

        hosts="$(printf '%s\n' "$urls" | sed 's|^https://||')"
        host_count=$(printf '%s\n' "$hosts" | sed '/^$/d' | wc -l | tr -d ' ')

        echo "â„¹ï¸ hosts found: $host_count"

        if [[ -n "$hash" ]]; then
          if [[ "$host_count" -eq 0 ]]; then
            echo "âŒ Error: no host found for hash '$hash'." >&2
            exit 1
          fi
          if [[ "$host_count" -gt 1 ]]; then
            echo "âŒ Error: multiple hosts found for hash '$hash' (expected exactly 1):" >&2
            printf '%s\n' "$hosts" >&2
            exit 1
          fi
        fi

        echo "found=true" >> "$GITHUB_OUTPUT"

        echo "hosts<<__EOF__" >> "$GITHUB_OUTPUT"
        echo "$hosts" >> "$GITHUB_OUTPUT"
        echo "__EOF__" >> "$GITHUB_OUTPUT"

        echo "ids<<__EOF__" >> "$GITHUB_OUTPUT"
        echo "$ids" >> "$GITHUB_OUTPUT"
        echo "__EOF__" >> "$GITHUB_OUTPUT"
