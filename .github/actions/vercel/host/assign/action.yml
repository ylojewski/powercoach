name: Assign Vercel host
description: Assign a custom host to a Vercel deployment given its ID

inputs:
  check:
    description: Checks if the host is already assigned
    required: false
    default: 'false'
  host:
    description: Host to assign
    required: true
  id:
    description: Vercel deployment ID
    required: true

outputs:
  skipped:
    description: Whether assignment was skipped
    value: ${{ steps.check.outputs.assigned || 'false' }}

runs:
  using: composite
  steps:
    - name: Check assignment
      id: check
      if: inputs.check == 'true'
      shell: bash
      run: |
        echo "ğŸŒ Checking alias assignment for:"
        echo "  -- ID â‡’ ${{ inputs.id }}"
        echo "  -- Alias â‡’ ${{ inputs.host }}"

        aliases=$(
          curl \
            --silent \
            --fail \
            --request GET \
            --header "Authorization: Bearer $VCL_TOKEN" \
            --url "https://api.vercel.com/v2/deployments/${{ inputs.id }}/aliases" \
          | jq -r '.aliases[].alias // empty'
        )

        if echo "$aliases" | grep -Fq "${{ inputs.host }}"; then
          echo "ğŸŒ Checked alias assigment â‡’ set"
          echo "assigned=true" >> "$GITHUB_OUTPUT"
        else
          echo "ğŸŒ Checked alias assigment â‡’ not set"
          echo "assigned=false" >> "$GITHUB_OUTPUT"
        fi

    - name: Assign Vercel alias
      id: assign
      if: inputs.check != 'true' || steps.check.outputs.assigned == 'false'
      shell: bash
      run: |
        echo "ğŸŒ Assigning alias for deployment:"
        echo "  -- ID â‡’ ${{ inputs.id }}"
        echo "  -- Alias â‡’ ${{ inputs.host }}"

        response=$(
          curl \
            --silent \
            --fail \
            --request POST \
            --header "Authorization: Bearer $VCL_TOKEN" \
            --header 'Content-Type: application/json' \
            --url "https://api.vercel.com/v2/deployments/${{ inputs.id }}/aliases" \
            --data "$(jq -n --arg alias "${{ inputs.host }}" '{ alias: $alias }')" \
          | jq -r '.alias // empty'
        )

        if [[ -z "$response" ]]; then
          echo "âŒ Failed to assign alias (missing host)"
          exit 1
        fi

        echo "ğŸŒ Alias assigned â‡’ ${{ inputs.host }}"
