name: Find Vercel hosts
description: Retrieves deployment hosts & IDs from Vercel API

inputs:
  issue-number:
    description: Issue number of the pull request event (used as metadata)
    required: false
  manager-hash:
    description: Hash of the Manager source directory (used as metadata)
    required: false
  target:
    description: Vercel target environment (preview|production)
    required: true

outputs:
  found:
    description: true if at least one host was found
    value: ${{ steps.find.outputs.found }}
  hosts:
    description: All hosts found (one per line)
    value: ${{ steps.find.outputs.hosts }}
  ids:
    description: All deployment IDs found (one per line, aligned with hosts)
    value: ${{ steps.find.outputs.ids }}

runs:
  using: composite
  steps:
    - name: Find Vercel hosts
      id: find
      shell: bash
      run: |
        if ! [[ "${{ inputs.target }}" =~ ^(preview|production)$ ]]; then
          echo "âŒ Error: invalid target=${{ inputs.target }} (allowed: preview|production)"
          exit 2
        fi

        query="target=${{ inputs.target }}"
        [[ -n "${{ inputs.manager-hash }}" ]] && query+="&meta-powercoachManagerHash=${{ inputs.manager-hash }}"
        [[ -n "${{ inputs.issue-number }}" ]] && query+="&meta-powercoachIssueNumber=${{ inputs.issue-number }}"

        url="https://api.vercel.com/v6/deployments?$query"

        echo "ðŸ” Querying Vercel with:"
        echo "  --url â‡’ $url"

        response=$(
          curl \
            --silent \
            --fail \
            --header "Authorization: Bearer $VCL_TOKEN" \
            --url "$url"
        )

        urls="$(printf '%s\n' "$response" | jq -r '.deployments[].url // empty')"
        ids="$(printf '%s\n' "$response" | jq -r '.deployments[].uid // empty')"

        if [[ -z "$urls" ]]; then
          echo "â„¹ï¸ No hosts found"
          echo "found=false" >> "$GITHUB_OUTPUT"
          echo "hosts=" >> "$GITHUB_OUTPUT"
          echo "ids=" >> "$GITHUB_OUTPUT"
          exit 0
        fi

        hosts="$(printf '%s\n' "$urls" | sed 's|^https://||')"
        host_count=$(printf '%s\n' "$hosts" | sed '/^$/d' | wc -l | tr -d ' ')

        echo "â„¹ï¸ Hosts found: $host_count"

        if [[ -n "${{ inputs.manager-hash }}" ]]; then
          if [[ "$host_count" -eq 0 ]]; then
            echo "âŒ Error: no hosts found with manager-hash=${{ inputs.manager-hash }}." >&2
            exit 3
          fi
          if [[ "$host_count" -gt 1 ]]; then
            echo "âŒ Error: multiple hosts found with manager-hash=${{ inputs.manager-hash }} (expected exactly 1):" >&2
            printf '%s\n' "$hosts" >&2
            exit 4
          fi
        fi

        echo "found=true" >> "$GITHUB_OUTPUT"

        echo "hosts<<__EOF__" >> "$GITHUB_OUTPUT"
        echo "$hosts" >> "$GITHUB_OUTPUT"
        echo "__EOF__" >> "$GITHUB_OUTPUT"

        echo "ids<<__EOF__" >> "$GITHUB_OUTPUT"
        echo "$ids" >> "$GITHUB_OUTPUT"
        echo "__EOF__" >> "$GITHUB_OUTPUT"
