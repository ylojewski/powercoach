name: Prune Manager
description: Prune Vercel preview deployments for the given branch SHA

inputs:
  branch-sha:
    description: Github branch SHA
    required: true

runs:
  using: composite
  steps:
    - uses: ./.github/actions/core/summary
      with:
        title: Prune Manager inputs
        data: '{ "Branch SHA": "${{ inputs.branch-sha }}" }'

    - name: Find deployments
      id: find-deployments
      uses: ./.github/actions/vercel/find-all
      with:
        branch-sha: ${{ inputs.branch-sha }}
        deploy-target: 'preview'

    - name: Delete deployed hosts
      if: steps.find-deployments.outputs.found == 'true'
      shell: bash
      run: |
        echo "ğŸ§¹ Deleting existing preview deployments..."

        printf '%s\n' "${{ steps.find-deployments.outputs.hosts }}" | while IFS= read -r host; do
          if curl \
            --silent \
            --fail \
            --request DELETE \
            --header "Authorization: Bearer $VCL_TOKEN" \
            --url "https://api.vercel.com/v13/deployments/ignored?url=$host" \
            >/dev/null
          then
            echo "  -- âœ… Deleted â‡’ $host"
          else
            echo "  -- âŒ Failed to delete deployment â‡’ $host"
            exit 1
          fi
        done

    - uses: ./.github/actions/core/summary
      with:
        title: Prune Manager tasks
        layout: 'list'
        level: '4'
        data: |
          {
            "find-deployments.found": "${{ steps.find-deployments.outputs.found }}",
            "find-deployments.hosts": ${{ toJSON(steps.find-deployments.outputs.hosts) }}
          }
